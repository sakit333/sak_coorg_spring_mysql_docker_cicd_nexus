pipeline {
    agent any

    parameters {
        choice(
            name: 'ACTION',
            choices: ['start', 'stop', 'terminate'],
            description: 'Choose what to do with the Nexus Repository container'
        )
    }

    environment {
        COMPOSE_FILE = 'nexus_repo_docker/docker-compose.yml'
        NETWORK_NAME = 'sak-network'
    }

    stages {
        stage('Validate Network') {
            when { expression { params.ACTION == 'start' } }
            steps {
                echo "üîç Checking if Docker network '${NETWORK_NAME}' exists..."
                sh '''
                if sudo docker network inspect ${NETWORK_NAME} >/dev/null 2>&1; then
                  echo "‚úÖ Network '${NETWORK_NAME}' already exists."
                else
                  echo "‚öôÔ∏è  Network '${NETWORK_NAME}' not found. Creating it now..."
                  sudo docker network create ${NETWORK_NAME}
                fi
                '''
            }
        }

        stage('Build Nexus Image') {
            when { expression { params.ACTION == 'start' } }
            steps {
                echo "üõ†Ô∏è Building Nexus Repository image..."
                sh "sudo docker-compose -f ${COMPOSE_FILE} build nexus"
            }
        }

        stage('Start Nexus Container') {
            when { expression { params.ACTION == 'start' } }
            steps {
                echo "üöÄ Starting Nexus Repository container..."
                sh "sudo docker-compose -f ${COMPOSE_FILE} up -d nexus"
            }
        }
        stage('Get the admin password for Nexus') {
            when { expression { params.ACTION == 'start' } }
            steps {
                script {
                    echo "‚è≥ Waiting 2 minutes for Nexus to initialize..."
                    sleep time: 2, unit: 'MINUTES'
                    echo "üîê Checking if Nexus container is running..."
                    def containerId = sh(
                        script: "sudo docker ps -qf 'name=nexus-repo'",
                        returnStdout: true
                    ).trim()
                    if (!containerId) {
                        echo "‚ö†Ô∏è Nexus container is not running. Skipping admin password retrieval."
                        return
                    }
                    echo "‚úÖ Nexus container is running. Waiting for admin.password file..."
                    timeout(time: 5, unit: 'MINUTES') {
                        waitUntil {
                            def fileExists = sh(
                                script: "sudo docker exec ${containerId} sh -c 'test -f /nexus-data/admin.password && echo exists || echo missing'",
                                returnStdout: true
                            ).trim()
                            if (fileExists == "exists") {
                                echo "‚úÖ admin.password file found."
                                return true
                            }
                            echo "‚è≥ Still waiting for Nexus to generate admin.password..."
                            sleep 10
                            return false
                        }
                    }
                    def adminPassword = sh(
                        script: "sudo docker exec ${containerId} cat /nexus-data/admin.password",
                        returnStdout: true
                    ).trim()
                    echo "\n================ Nexus Admin Credentials ================"
                    echo "üë§ Username: admin"
                    echo "üîë Password: ${adminPassword}"
                    echo "==========================================================\n"
                    input message: "üìã Copy the above password and click 'Proceed' when ready."
                }
            }
        }

        stage('Stop Nexus Container') {
            when { expression { params.ACTION == 'stop' } }
            steps {
                echo "üõë Stopping Nexus Repository container..."
                sh "sudo docker-compose -f ${COMPOSE_FILE} stop nexus"
            }
        }

        stage('Terminate Nexus Container') {
            when { expression { params.ACTION == 'terminate' } }
            steps {
                echo "‚ùå Removing Nexus Repository container, image, and volumes..."
                sh '''
                sudo docker-compose -f ${COMPOSE_FILE} down -v || true

                echo "üßπ Cleaning up Nexus images..."
                sudo docker rmi -f sonatype/nexus3 || echo "‚ö†Ô∏è Base image not found, skipping..."
                sudo docker rmi -f nexus_repo_docker_nexus || echo "‚ö†Ô∏è Custom Nexus image not found, skipping..."
                '''
            }
        }

        stage('Show Nexus Status') {
            steps {
                echo "üì¶ Current Nexus Repository container status:"
                sh "sudo docker-compose -f ${COMPOSE_FILE} ps"
                echo "üåê Current Docker networks:"
                sh "sudo docker network ls | grep ${NETWORK_NAME} || true"
            }
        }
    }

    post {
        success {
            echo "‚úÖ Pipeline completed successfully for action: '${params.ACTION}'"
        }
        failure {
            echo "‚ùå Pipeline failed during action: '${params.ACTION}'"
        }
        always {
            echo "‚ÑπÔ∏è Pipeline finished. Check logs above for details."
        }
    }
}
